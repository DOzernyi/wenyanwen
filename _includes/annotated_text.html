<div class="annotated-container">
  <div class="annotated-main" id="annotated-content-{{ include.id | default: 'main' }}">
    {{ include.content }}
  </div>
  <div class="annotated-notes" id="annotated-notes-{{ include.id | default: 'main' }}">
  </div>
</div>
<script>
(function() {
  var containerId = '{{ include.id | default: "main" }}';
  var container = document.getElementById('annotated-content-' + containerId);
  var notesContainer = document.getElementById('annotated-notes-' + containerId);
  var annotatedContainer = container.parentElement;
  var refs = container.querySelectorAll('.note-ref[data-note-text]');
  var sidenotes = [];
  var labelCounters = {};

  refs.forEach(function(ref) {
    var label = ref.getAttribute('data-note-label') || 'æ³¨';
    var text = ref.getAttribute('data-note-text');
    var color = ref.getAttribute('data-note-color') || '#267CB9';
    
    if (!labelCounters[label]) {
      labelCounters[label] = 0;
    }
    labelCounters[label]++;
    var numberedId = label + labelCounters[label];
    
    ref.textContent = numberedId;
    ref.setAttribute('data-note-id', numberedId);
    
    if (text) {
      var note = document.createElement('div');
      note.className = 'sidenote';
      note.style.borderLeftColor = color;
      note.innerHTML = '<span class="note-marker" style="background-color: ' + color + ';">' + numberedId + '</span> ' + text;
      notesContainer.appendChild(note);
      
      var parentP = ref.closest('p');
      sidenotes.push({ ref: ref, note: note, parentP: parentP });
    }
  });

  function positionSidenotes() {
    var isMobile = window.innerWidth <= 768;
    
    var paragraphs = container.querySelectorAll('p');
    paragraphs.forEach(function(p) {
      p.style.marginBottom = '';
    });
    
    if (isMobile) {
      sidenotes.forEach(function(item) {
        item.note.style.position = 'static';
        item.note.style.top = '';
      });
      return;
    }

    var containerRect = annotatedContainer.getBoundingClientRect();
    var lastBottom = 0;
    
    var paragraphMaxBottom = {};
    
    sidenotes.forEach(function(item, index) {
      var refRect = item.ref.getBoundingClientRect();
      var targetTop = refRect.top - containerRect.top;
      
      if (targetTop < lastBottom) {
        targetTop = lastBottom;
      }
      
      item.note.style.position = 'absolute';
      item.note.style.top = targetTop + 'px';
      item.note.style.left = '0';
      item.note.style.right = '0';
      
      var noteBottom = targetTop + item.note.offsetHeight + 8;
      lastBottom = noteBottom;
      
      if (item.parentP) {
        var pId = Array.prototype.indexOf.call(paragraphs, item.parentP);
        if (pId >= 0) {
          if (!paragraphMaxBottom[pId] || noteBottom > paragraphMaxBottom[pId]) {
            paragraphMaxBottom[pId] = noteBottom;
          }
        }
      }
    });
    
    for (var pId in paragraphMaxBottom) {
      var p = paragraphs[pId];
      if (p) {
        var pRect = p.getBoundingClientRect();
        var pBottom = pRect.bottom - containerRect.top;
        var footnotesBottom = paragraphMaxBottom[pId];
        
        if (footnotesBottom > pBottom) {
          var extraSpace = footnotesBottom - pBottom;
          p.style.marginBottom = extraSpace + 'px';
        }
      }
    }
    
    positionSidenotesPass2();
  }
  
  function positionSidenotesPass2() {
    var containerRect = annotatedContainer.getBoundingClientRect();
    var lastBottom = 0;
    
    sidenotes.forEach(function(item) {
      var refRect = item.ref.getBoundingClientRect();
      var targetTop = refRect.top - containerRect.top;
      
      if (targetTop < lastBottom) {
        targetTop = lastBottom;
      }
      
      item.note.style.top = targetTop + 'px';
      lastBottom = targetTop + item.note.offsetHeight + 8;
    });
  }

  setTimeout(positionSidenotes, 100);
  
  window.addEventListener('resize', function() {
    setTimeout(positionSidenotes, 100);
  });
  window.addEventListener('load', function() {
    setTimeout(positionSidenotes, 100);
  });
})();
</script>
